---
title: 来了物联_小程序
date: 2022-06-30 11:50:09
permalink: /pages/0ce3e6/
categories:
  - 运维
  - 项目部署
tags:
  - 
---


# 来了物联_小程序部署





###  接口容器  laile-iot-api 

```shell
docker run --restart always --name laile-iot-api  -p 18081:8080/tcp -v /home/java/laile-iot/app.jar:/app.jar  -v /home/java/laile-iot/app_logs:/logs/app_logs -v /etc/localtime:/etc/localtime  -it -d adoptopenjdk/openjdk8-openj9:jdk8u292-b10_openj9-0.26.0-centos  java -jar -Dfile.encoding=utf-8 /app.jar  --server.port=8080 -Duser.timezone=GMT+08
```





### 蓝绿发布 测试包

```shell
docker run --restart always --name laile-iot-api-test  -p 18083:8080/tcp -v /home/java/laile-iot-test/app.jar:/app.jar  -v /home/java/laile-iot-test/app_logs:/logs/app_logs -v /etc/localtime:/etc/localtime  -it -d adoptopenjdk/openjdk8-openj9:jdk8u292-b10_openj9-0.26.0-centos  java -jar -Dfile.encoding=utf-8 /app.jar  --server.port=8080 -Duser.timezone=GMT+08
```





### 沙盒测试

```shell
docker run --restart always --name laile-iot-api-sandbox -p 18084:8080/tcp -v /home/sandbox/api/app.jar:/app.jar  -v /home/sandbox/api/app_logs:/logs/app_logs -v /etc/localtime:/etc/localtime  -it -d adoptopenjdk/openjdk8-openj9:jdk8u292-b10_openj9-0.26.0-centos  java -jar -Dfile.encoding=utf-8 /app.jar  --server.port=8080 -Duser.timezone=GMT+08
```



接口jar 所在路径  /home/java/laile-iot

管理后台页面所在路径 /home//page/admin

Nginx 配置所在路径  /www/server/panel/vhost/nginx/



### nginx 配置文件

 shark.alicbin.com.conf

```nginx
 server {
        listen  80;              #配置监听端口和主机名称
        server_name api.alicbin.com;	
        location /{
                proxy_pass http://127.0.0.1:18081;  #直接
	            proxy_set_header    Host   $host:80;  #不添加这行时访问需要 域名:7001才能访问到内网的机器，如果加了就不再需要后面的端口，直接使用域名访问
				proxy_set_header    X-Real-IP       $remote_addr;
				proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
			            proxy_set_header Via "nginx";
				proxy_hide_header   X-Powered-By;

        }
   		
			location /admin{
			index index.php index.html index.htm default.php default.htm default.html;
			root /home/page;
	    	}   
	    	
	 
		
		#任务调度中心
		    location /xxl-job-admin {
		        proxy_pass http://127.0.0.1:18082;  #直接
	            proxy_set_header    Host   $host:80;  #不添加这行时访问需要 域名:7001才能访问到内网的机器，如果加了就不再需要后面的端口，直接使用域名访问
				proxy_set_header    X-Real-IP       $remote_addr;
				proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
			            proxy_set_header Via "nginx";
				proxy_hide_header   X-Powered-By;
		}    
		
		
    }
      
      
    server {
	        listen 443 ssl;
	        server_name shark.alicbin.com;
			ssl_certificate	/home/ssl/22_23_api.laileiot.com.pem;
	        #ssl_certificate			/cert/rc-pt.cn/server.crt;
	        ssl_certificate_key	/home/ssl/22_23_api.laileiot.com.key;
	        #ssl_certificate_key		/cert/rc-pt.cn/server.key;
	        #ssl_dhparam			/cert/rc-pt.cn/server.pem;
	        ssl_session_timeout 5m;
	        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
			#ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
	        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	        ssl_prefer_server_ciphers on;
	        
		        location /{
		                proxy_pass http://127.0.0.1:18081;  #直接
			            proxy_set_header    Host   $host:80;  #不添加这行时访问需要 域名:7001才能访问到内网的机器，如果加了就不再需要后面的端口，直接使用域名访问
						proxy_set_header    X-Real-IP       $remote_addr;
						proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
					            proxy_set_header Via "nginx";
						proxy_hide_header   X-Powered-By;
		        }
	       
			
	    }
	    
	    
	    


```

 

​	



1.小区的的流水利润 和 成本费用。绑定在【小区】的还是 绑定在 【小区的站长】上的。

2.目前因为在计算经营性成本扣费，发现个问题，如果流水利润在 站长用户上。那如果更换站长，那当前的利润 和 欠费情况都会被旧站长带走





scene=scan_device&device_type=drink_water&device_id=2



scene=scan_device&device_type=drink_water&device_id=2





![image-20220731215034747](/Users/binpro/Library/Application%20Support/typora-user-images/image-20220731215034747.png)

```vue
<template>
	<view>
		<!-- <u-navbar :autoBack="true"  v-if="type == '1'" :title="title" :border-bottom="borderBottom" title-bold title-color="#000"
			back-icon-color="#000"  @leftClick="onBack"  :bgColor="_bgColor" :placeholder="!_immersive">	
		</u-navbar> -->
		<u-navbar :title="title" :border-bottom="borderBottom" title-bold title-color="#000" back-icon-color="#000"
			:bgColor="_bgColor" :placeholder="!_immersive">
			<view v-show="type != '0'" class="u-nav-slot" slot="left">
				<div class="type1" v-if="type == '1'" @tap="onBack">
					<u-icon name="arrow-left" size="24"></u-icon>
				</div>
				<div class="back type2" v-if="type == '2'" :style="{'height':header_height+'px','width':header_width+'px'}">
					<div class="icon" @tap="onBack">
						<span class="ma icon-back"></span>
					</div>
					<div class="icon" @tap="onHome">
						<span class="ma icon-home"></span>
					</div>
				</div>
			<div class="back type3" v-else-if="type == '3'" :style="{'height':header_height+'px','width':header_width+'px'}">
					<div class="icon" @tap="onBack">
						<span class="ma icon-back"></span>
					</div>
					<div class="icon" @tap="onHome">
						<span class="ma icon-home"></span>
						</div>
			</div>
			
			<div class="back type4" v-else-if="type == '4'" :style="{'height':header_height+'px','width':header_width+'px'}">
					<div class="icon" @tap="onBack">
						<span class="ma icon-back"></span>
					</div>
					<div class="icon" @tap="onHome">
						<span class="ma icon-home"></span>
						</div>
			</div>
				<!-- <image class="type4" v-else-if="type == '4'" src="@/static/img/tabbar/activity2.png" mode=""></image> -->
			</view>
		</u-navbar>
	</view>
</template>

<script>
	export default {
		props: {
			//4种头部类型
			//0: 底部tabar类型的头部，没有返回图标
			//1: 普通的页面头部，只有一个返回图标
			//2: 爪爪pet那样的头部，多了一个返回首页的图标
			//3: 回馈日那样的沉浸式头部，高度塌陷
			type: {
				type: String,
				default: '1'
			},
			title: {
				type: String,
				default: ''
			},
			borderBottom: {
				type: Boolean,
				default: false
			},
			bgColor: {
				type: String,
				default: '#FFF'
			},
			isBackToMini: {
				type: Boolean,
				default: false
			}
		},
		data() {
			return {
				_isBack: true, //是否显示返回图标
				_immersive: false, //头部是否塌陷 2.0 改成是否占位了 placeholder
				_bgColor: '#FFF', //头部背景颜色
				header_width : 0, // 头部宽度
				header_height : 0 // 头部高度
			}
		},
		mounted() {
			this.init();
			this.calculationHeight();
		},
		methods: {
			// 计算胶囊高度的函数
			calculationHeight(){
				let res = wx.getMenuButtonBoundingClientRect();
				// console.log(res);
				this.header_height = res.height;
				this.header_width = res.width;
			},
			init() {
				switch (this.type) {
					case '0':
						this.getHeaderType0();
						break;
					case '1':
						this.getHeaderType1();
						break;
					case '2':
						this.getHeaderType2();
						break;
					case '3':
						this.getHeaderType3();
					case '4':
						this.getHeaderType4();
						break;
					default:
						break;
				}
				this.$forceUpdate()
			},
			//第一种头部类型
			getHeaderType0() {
				this._bgColor = this.bgColor;
				this._isBack = false;
				this._immersive = false;
			},
			//第二种头部类型
			getHeaderType1() {
				this._bgColor = this.bgColor;
				this._isBack = true;
				this._immersive = false;
			},
			//第二种头部类型
			getHeaderType2() {
				console.log('第二种头部类型')
				this._isBack = false;
				this._immersive = false;
				this._bgColor = '#FFF';
				//修改右上角胶囊颜色
				uni.setNavigationBarColor({
					frontColor: '#000000',
					backgroundColor: '#000000'
				})
			},
			//第三种头部类型
			getHeaderType3() {
				console.log('第三种头部类型')
				this._isBack = false;
				this._immersive = true;
				this._bgColor = 'transparent';
				//修改右上角胶囊颜色
				uni.setNavigationBarColor({
					frontColor: '#ffffff',
					backgroundColor: '#ffffff'
				})
			},
			//第四种头部类型
			getHeaderType4() {
				console.log('第四种头部类型')
				this._isBack = false;
				this._immersive = true;
				this._bgColor = 'transparent';
				//修改右上角胶囊颜色
				uni.setNavigationBarColor({
					frontColor: '#000000',
					backgroundColor: '#000000'
				})
			},
			onBack() {
				if (this.isBackToMini) {
					wx.navigateBackMiniProgram({
						success(res) {

							// 返回成功
						}
					})
				} else {
					uni.navigateBack({
						fail(err) {
							console.log(err)
							uni.switchTab({
								url: '/pages/index/index'
							})
						}
					})
				}
			},
			onHome() {
				uni.switchTab({
					url: '/pages/index/index'
				})
			}
		},
		watch: {
			//头部类型
			type(newVal, oldVal) {
				this.init()
			}
		}
	}
</script>

<style lang="scss">
	.type1{
		width: 6.4vw;
		height: 6.4vw;
		// background-color: red;
		// margin-left: 4.86vw;
		margin-left: 1.86vw;
	}
	.type2 {
		background-color: #FFF;
		border: 0.5px solid rgba(233, 233, 233, .8);

		.icon {
			&:first-child {
				border-right: 0.5px solid rgba(233, 233, 233, .8);
			}

			.ma {
				color: #000;
			}
		}
	}

	.type3 {
		background: rgba(0, 0, 0, .2);
		border: 0.5px solid rgba(255, 255, 255, 0.2);

		.icon {
			&:first-child {
				border-right: 0.5px solid rgba(255, 255, 255, 0.4);
			}

			.ma {
				color: #FFF;
			}
		}
	}
	.type4 {
		opacity: 0.8;
		background-color: #FFF;
		border: 0.5px solid rgba(233, 233, 233, 0.5);
	
		.icon {
			&:first-child {
				border-right: 0.5px solid rgba(233, 233, 233, 0.5);
			}
	
			.ma {
				color: #000;
			}
		}
	}

	.back {
		// width: 23.2vw;
		// height: 8.43vw;
		// height: 8.53vw;
		// background-color: rgba(37, 37, 37, .2);
		// border: 0.17vw solid rgba(0,0,0,0.2);
		border-radius: 16px;
		display: flex;
		align-items: center;
		margin-bottom: 1.3vw;
		margin-left: 2.13vw;

		.icon-back {
			font-size: 6.27vw;
		}

		.icon {
			font-size: 3.73vw;
			width: 50%;
			height: 4.8vw;
			line-height: 4.8vw;
			text-align: center;
			display: flex;
			align-items: center;
			justify-content: center;

			// &:first-child{
			// 	border-right: 0.17vw solid rgba(0, 0, 0, 0.4);
			// }
			image {
				width: 50%;
				height: 4.8vw;
			}
		}
	}

	.type4 {
		height: 10vw;
		width: 10vw;
	}
</style>

```



云龙看了文档，发现有2个疑问，

1.就是你的数据响应没有对应的状态说明，是直接使用通用网络请求状态是吗

2.你的请求参数，都是清一色的参数可以不传



### 邮箱发送记录(sys_mail_log)
| 字段名 | 字段说明 | 字段类型 | 默认值 | 是否为空 |
|------ |------ |------ |------ |------ |
|id |主键 |bigint |null |不为空 |
|subject |邮件主题 |varchar |null |是 |
|content |邮件内容 |longtext |null |是 |
|sender_mail |发件人邮箱 |varchar |null |是 |
|success_mails |成功接受者 |longtext |null |是 |
|fail_mails |失败接受者 |longtext |null |是 |
|create_by |上传人 |varchar | |是 |
|update_by |更新人 |varchar | |是 |
|create_time |创建时间 |datetime |CURRENT_TIMESTAMP |是 |
|update_time |更新时间 |datetime |null |是 |
|status |状态 -1= 进行中,1=已完成 |int |-1 |是 |

{"batch_id":"1030000015701444949062022082201046531011","create_time":"2022-08-22T18:07:39+08:00","out_batch_no":"1561656288233611264"}

```
"{\"transfer_batch\":{\"appid\":\"wx0b779674943d96d8\",\"batch_id\":\"1030000015701444949062022082201046531011\",\"batch_name\":\"测试\",\"batch_remark\":\"测试\",\"batch_status\":\"FINISHED\",\"batch_type\":\"API\",\"create_time\":\"2022-08-22T18:07:39+08:00\",\"fail_amount\":30,\"fail_num\":1,\"mchid\":\"1624302363\",\"out_batch_no\":\"1561656288233611264\",\"success_amount\":0,\"success_num\":0,\"total_amount\":30,\"total_num\":1,\"transfer_scene_id\":\"\",\"update_time\":\"2022-08-22T18:07:40+08:00\"},\"transfer_detail_list\":[]}"
```
