(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{536:function(s,a,t){"use strict";t.r(a);var n=t(17),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"docker-实战-使用-dockerfile-构建镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-实战-使用-dockerfile-构建镜像"}},[s._v("#")]),s._v(" "),t("a",{attrs:{href:"https://www.cnblogs.com/cloudfloating/p/11788000.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker 实战—使用 Dockerfile 构建镜像"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("GitHub Page：http://blog.cloudli.top/posts/Docker实战-使用-Dockerfile-构建镜像/")]),s._v(" "),t("p",[s._v("Dockerfile 指令详解请访问：https://www.cnblogs.com/cloudfloating/p/11737447.html")]),s._v(" "),t("h2",{attrs:{id:"使用-alpine-linux-作为基础镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-alpine-linux-作为基础镜像"}},[s._v("#")]),s._v(" 使用 Alpine Linux 作为基础镜像")]),s._v(" "),t("p",[s._v("Alpine 是一个非常轻量的 Linux 镜像，他只有大约 5MB 的大小，基于它构建镜像，可以大大减少镜像的体积。")]),s._v(" "),t("p",[s._v("Alpine 的 Docker Hub 页面：https://hub.docker.com/_/alpine")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker pull alpine\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Alpine 使用 "),t("code",[s._v("apk")]),s._v(" 命令来安装软件包，支持的软件包列表可以在官网查看：https://pkgs.alpinelinux.org/packages")]),s._v(" "),t("p",[s._v("这里以安装 Nginx 为例，学习镜像的构建。另外 Nginx 本身有官方镜像，pull 即可。")]),s._v(" "),t("h2",{attrs:{id:"构建-nginx-镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建-nginx-镜像"}},[s._v("#")]),s._v(" 构建 Nginx 镜像")]),s._v(" "),t("h3",{attrs:{id:"编写-dockerfile"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写-dockerfile"}},[s._v("#")]),s._v(" 编写 Dockerfile")]),s._v(" "),t("div",{staticClass:"language-dockerfile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk update "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 nginx")]),s._v("\n    apk add --no-cache nginx "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    mkdir /run/nginx && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清除缓存")]),s._v("\n    rm -rf /tmp/* /var/cache/apk/*")]),s._v("\n    \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加容器启动命令，启动 nginx，以前台方式运行")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" [ "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-g"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"daemon off;"')]),s._v(" ]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("这里有一个坑点，必须创建 "),t("code",[s._v("/run/nginx")]),s._v(" 目录，不然会报错。")]),s._v(" "),t("h3",{attrs:{id:"构建镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建镜像"}},[s._v("#")]),s._v(" 构建镜像")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("docker build")]),s._v(" 命令构建：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker build -t nginx-alpine "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("在 Dockerfile 目录下执行以上命令即可构建镜像。"),t("code",[s._v("-t")]),s._v(" 参数指定了镜像名称为 "),t("code",[s._v("nginx-alpine")]),s._v("，最后的 "),t("code",[s._v(".")]),s._v(" 表示构建上下文（"),t("code",[s._v(".")]),s._v(" 表示当前目录）.")]),s._v(" "),t("p",[t("strong",[s._v("在使用 "),t("code",[s._v("COPY")]),s._v(" 指令复制文件时，指令中的源路径是相对于构建上下文的")]),s._v("（如果指定上下文为 "),t("code",[s._v("/home")]),s._v("，那么相当于所有的源路径前面都加上了 "),t("code",[s._v("/home/")]),s._v("）。")]),s._v(" "),t("p",[s._v("如果你的 Dockerfile 文件名不是 “Dockerfile”，可以使用 "),t("code",[s._v("-f")]),s._v(" 参数指定。")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("千万不要将 Dockerfile 放在根目录下构建，假如你将 Dockerfile 放在一个存放大量视频目录下，并且构建上下文为当前目录，那么镜像将会非常大（视频都被打包进去了）")]),s._v("。最佳做法是将 Dockerfile 和需要用到的文件放在一个单独的目录下。")])]),s._v(" "),t("h2",{attrs:{id:"运行容器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#运行容器"}},[s._v("#")]),s._v(" 运行容器")]),s._v(" "),t("p",[s._v("使用构建的镜像运行容器：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker run --name my-nginx -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":80 -d nginx-apline\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[t("code",[s._v("--name")]),s._v(" 指定容器的名称，可以省略（后续只能通过容器 id 来操作）；")]),s._v(" "),t("li",[t("code",[s._v("-p")]),s._v(" 映射端口，宿主端口 -> 容器端口；")]),s._v(" "),t("li",[t("code",[s._v("-d")]),s._v(" 后台运行。")])]),s._v(" "),t("p",[s._v("运行后访问 "),t("code",[s._v("http://localhost/")]),s._v("，会出现一个 nginx 的 404 页面，说明已经运行成功了，因为这里安装的 Nginx 并没有默认页面，"),t("code",[s._v("/etc/nginx/conf.d/default.conf")]),s._v(" 中的内容：")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# This is a default site configuration which will simply return 404, preventing\n# chance access to any other virtualhost.\n\nserver {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n\n        # Everything is a 404\n        location / {\n                return 404;\n        }\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("h3",{attrs:{id:"使用构建的-nginx-镜像运行一个静态页面"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用构建的-nginx-镜像运行一个静态页面"}},[s._v("#")]),s._v(" 使用构建的 Nginx 镜像运行一个静态页面")]),s._v(" "),t("p",[s._v("在一个空目录下创建 Nginx 配置文件：")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("server {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n\n        root /var/www;\n        \n        location / {\n                index index.html;\n        }\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("编写一个静态页面：")]),s._v(" "),t("div",{staticClass:"language-html line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-html"}},[t("code",[t("span",{pre:!0,attrs:{class:"token doctype"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<!")]),t("span",{pre:!0,attrs:{class:"token doctype-tag"}},[s._v("DOCTYPE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token name"}},[s._v("html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("head")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("title")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("Index"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("title")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("head")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("body")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("h1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("Hello, Docker!"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("h1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("body")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("使用之前构建的镜像构建一个新的镜像：")]),s._v(" "),t("div",{staticClass:"language-dockerfile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" nginx-alpine")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拷贝配置文件，覆盖默认的")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" default.conf /etc/nginx/conf.d/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拷贝静态页面")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" index.html /var/www")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("构建镜像、运行容器：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker build -t site "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\ndocker run --name my-site -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":80 -d site\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("现在访问 "),t("code",[s._v("http://localhost/")]),s._v("，就可以看到 Hello, Docker!")])])}),[],!1,null,null,null);a.default=e.exports}}]);